name: Dry Run Flask API
on: [push, pull_request]

jobs:
  dry-run:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Dry-run Docker build
      run: docker buildx build --dry-run . -t flask-api:test

    - name: Set up Helm
      uses: azure/setup-helm@v4

    - name: Lint Helm chart
      run: helm lint ./flask-chart

    - name: Dry-run Helm template
      run: |
        helm template flask-api ./flask-chart --debug > rendered.yaml
        echo "✅ Rendered manifests:"
        grep -E "(kind|apiVersion)" rendered.yaml | head -10

    - name: Install kubeval
      run: |
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar -xzf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin/

    - name: Validate rendered YAML
      run: |
        kubeval --strict rendered.yaml
        echo "✅ All manifests valid!"
