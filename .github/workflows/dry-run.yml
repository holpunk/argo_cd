name: CI - Dry Run & Auto-Generate Helm
on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Validate Docker build
      run: docker build --no-cache . -t flask-api:test

    - name: Set up Helm
      uses: azure/setup-helm@v4

    - name: Install kubeval
      run: |
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar -xzf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin/

    - name: Generate & Lint Helm chart
      run: |
        # Clean any existing chart
        rm -rf flask-chart/
        
        # Auto-generate minimal Helm chart
        helm create flask-chart
        
        # Remove unnecessary templates
        rm -rf flask-chart/charts 
        rm -rf flask-chart/templates/tests
        rm flask-chart/templates/hpa.yaml 
        rm flask-chart/templates/ingress.yaml
        rm flask-chart/templates/serviceaccount.yaml
        rm flask-chart/templates/_helpers.tpl
        
        # Update values.yaml
        cat > flask-chart/values.yaml << 'EOF'
        replicaCount: 2
        image:
          repository: ghcr.io/${{ github.repository }}/flask-api
          pullPolicy: IfNotPresent
          tag: "${{ github.sha }}"
          port: 5000
        service:
          type: ClusterIP
          port: 80
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        EOF
        
        # Lint & validate
        helm lint ./flask-chart
        helm template flask-api ./flask-chart | kubeval --strict
        
        echo "âœ… Helm chart generated & validated!"

    - name: Show rendered manifests
      run: |
        helm template flask-api ./flask-chart | grep -E "(kind|apiVersion)" | head -10
