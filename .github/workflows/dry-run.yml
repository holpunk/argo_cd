name: CI - Dry Run & Auto-Generate Helm
on: [push, pull_request]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Validate Docker build
      run: docker build --no-cache . -t flask-api:test

    - name: Set up Helm
      uses: azure/setup-helm@v4

    - name: Generate & Lint Helm chart
      run: |
        # Auto-generate Helm chart
        helm create flask-chart
        rm -rf flask-chart/charts flask-chart/templates/tests
        rm flask-chart/templates/hpa.yaml flask-chart/templates/ingress.yaml
        
        # Update values.yaml for GitHub Container Registry
        cat > flask-chart/values.yaml << EOF
        replicaCount: 2
        image:
          repository: ghcr.io/${{ github.repository }}/flask-api
          pullPolicy: IfNotPresent
          tag: "${{ github.sha }}"
          port: 5000
        service:
          type: ClusterIP
          port: 80
        resources:
          limits:
            cpu: 100m
            memory: 128Mi
          requests:
            cpu: 50m
            memory: 64Mi
        EOF
        
        # Lint & validate
        helm lint ./flask-chart
        helm template flask-api ./flask-chart | kubeval --strict
        
        echo "âœ… Helm chart generated & validated!"

    - name: Show rendered manifests
      run: |
        helm template flask-api ./flask-chart --debug | head -50

  publish:
    needs: validate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v4

    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build & Push Docker
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: ghcr.io/${{ github.repository }}/flask-api:${{ github.sha }},ghcr.io/${{ github.repository }}/flask-api:latest
